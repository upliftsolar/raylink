<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Data Visualization with Multiple Data Sources</title>
    <!-- Include D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Include RxJS -->
    <script src="https://unpkg.com/rxjs/dist/bundles/rxjs.umd.min.js"></script>
</head>

<body>
    <h1>Bluetooth Data Visualization</h1>
    <!-- Toggle buttons -->
    <button id="toggleMultiply">Toggle Multiply Odd Messages</button>
    <button id="toggleDataSource">Toggle Data Source</button>
    <!-- SVG container for D3 -->
    <svg width="800" height="400"></svg>

    <script>
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");

        // Define scales
        const x = d3.scaleLinear().domain([0, 100]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 100]).range([height, 0]);

        // Define line generator
        const line = d3.line()
            .x(d => x(d.x))
            .y(d => y(d.y));

        // Append path for line chart
        const path = svg.append("path")
            .attr("stroke", "steelblue")
            .attr("fill", "none");

        // Initialize data arrays for two data sources
        let dataSource1 = Array.from({ length: 10 }, (_, i) => ({ x: i * 10, y: Math.random() * 100 }));
        let dataSource2 = Array.from({ length: 10 }, (_, i) => ({ x: i * 10, y: Math.random() * 100 }));
        let multiplyOdd = false;
        let useDataSource1 = true;

        // Function to update chart
        function update(data) {
            path.datum(data)
                .attr("d", line);
        }

        // RxJS Observables for two data sources
        const { interval, fromEvent } = rxjs;
        const { map, tap } = rxjs.operators;

        // Data stream for data source 1
        const dataStream1 = interval(1000).pipe(
            map((i) => ({ x: dataSource1.length * 10, y: Math.random() * 100 })),
            tap((point, index) => {
                // Modify data if the toggle is active
                if (multiplyOdd && index % 2 !== 0) {
                    point.y *= 2;
                }
                dataSource1.push(point);
                dataSource1.shift();
                if (useDataSource1) {
                    update(dataSource1);
                }
            })
        );

        // Data stream for data source 2
        const dataStream2 = interval(1000).pipe(
            map((i) => ({ x: dataSource2.length * 10, y: Math.random() * 100 })),
            tap((point, index) => {
                dataSource2.push(point);
                dataSource2.shift();
                if (!useDataSource1) {
                    update(dataSource2);
                }
            })
        );

        // Start data streams
        dataStream1.subscribe();
        dataStream2.subscribe();

        // Handle toggle multiply button click
        fromEvent(document.getElementById('toggleMultiply'), 'click').subscribe(() => {
            multiplyOdd = !multiplyOdd;
            console.log('Toggle multiply odd messages:', multiplyOdd);
        });

        // Handle toggle data source button click
        fromEvent(document.getElementById('toggleDataSource'), 'click').subscribe(() => {
            useDataSource1 = !useDataSource1;
            console.log('Toggle data source:', useDataSource1 ? 'Data Source 1' : 'Data Source 2');
            // Update chart immediately with the new data source
            update(useDataSource1 ? dataSource1 : dataSource2);
        });

        // Initial chart update
        update(dataSource1);
    </script>
</body>

</html>